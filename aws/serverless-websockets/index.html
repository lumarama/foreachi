<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Serverless Websockets | foreach i</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-17026194-4"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-17026194-4');
  </script>
    <meta name="description" content="Code snippets for developers">
    
    <link rel="preload" href="/assets/css/0.styles.629fc509.css" as="style"><link rel="preload" href="/assets/js/app.ec0a4671.js" as="script"><link rel="preload" href="/assets/js/2.fb7a5d33.js" as="script"><link rel="preload" href="/assets/js/12.421c849a.js" as="script"><link rel="prefetch" href="/assets/js/10.b5dfd685.js"><link rel="prefetch" href="/assets/js/11.ae7e092c.js"><link rel="prefetch" href="/assets/js/13.8e423531.js"><link rel="prefetch" href="/assets/js/14.64225bfa.js"><link rel="prefetch" href="/assets/js/15.ca92a660.js"><link rel="prefetch" href="/assets/js/16.afc3daa5.js"><link rel="prefetch" href="/assets/js/3.e237bab9.js"><link rel="prefetch" href="/assets/js/4.7c7cbcb6.js"><link rel="prefetch" href="/assets/js/5.973b2db8.js"><link rel="prefetch" href="/assets/js/6.ffe6f60a.js"><link rel="prefetch" href="/assets/js/7.4d2ba386.js"><link rel="prefetch" href="/assets/js/8.0a26ee58.js"><link rel="prefetch" href="/assets/js/9.e387a47e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.629fc509.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">foreach i</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/aws/" aria-current="page" class="sidebar-link">AWS</a></li><li><a href="/aws/dynamodb-javascript/" class="sidebar-link">DynamoDB with JavaScript</a></li><li><a href="/aws/serverless-websockets/" aria-current="page" class="active sidebar-link">Serverless Websockets</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="using-aws-lambda-to-handle-websocket-connections"><a href="#using-aws-lambda-to-handle-websocket-connections" class="header-anchor">#</a> Using AWS Lambda to Handle Websocket Connections</h1> <p>AWS provides ability to handle websocket connections using serverless services only: Lambda functions and API Gateway. Most likely you will also need DynamoDB, though this isn't strictly required.</p> <p>This example shows <a href="https://www.serverless.com/" target="_blank" rel="noopener noreferrer">Serverless Framework<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> configuration file to provision required AWS services, and JavaScript Lambda function that handles websocket connections.</p> <p>Your serverless.yml should look as follows:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">service</span><span class="token punctuation">:</span> backend

<span class="token key atrule">provider</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aws
  <span class="token key atrule">region</span><span class="token punctuation">:</span> us<span class="token punctuation">-</span>east<span class="token punctuation">-</span><span class="token number">2</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">runtime</span><span class="token punctuation">:</span> nodejs12.x

<span class="token key atrule">functions</span><span class="token punctuation">:</span>
  <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">handler</span><span class="token punctuation">:</span> src/handler.default
    <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">websocket</span><span class="token punctuation">:</span>
          <span class="token key atrule">route</span><span class="token punctuation">:</span> $connect
      <span class="token punctuation">-</span> <span class="token key atrule">websocket</span><span class="token punctuation">:</span>
          <span class="token key atrule">route</span><span class="token punctuation">:</span> $disconnect
      <span class="token punctuation">-</span> <span class="token key atrule">websocket</span><span class="token punctuation">:</span>
          <span class="token key atrule">route</span><span class="token punctuation">:</span> $default
</code></pre></div><p>We configured the same Lambda function to handle connect, disconnect, and default (message receiving) routes. Note <strong>handler: src/handler.default</strong> above: <strong>src/handler</strong> is the filename where the Lambda function is defined, and <strong>default</strong> is the name of the function itself.</p> <p>In the example we echo back the message we receive via websocket: <strong>event.body</strong> contains the message, <strong>event.requestContext.connectionId</strong> - current connection id.</p> <p>src/handler.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">response</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> 
    statusCode<span class="token operator">:</span> code<span class="token punctuation">,</span> 
    body<span class="token operator">:</span> body
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">echoReply</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> apigwManagementApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>ApiGatewayManagementApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    apiVersion<span class="token operator">:</span> <span class="token string">'2018-11-29'</span><span class="token punctuation">,</span>
    endpoint<span class="token operator">:</span> event<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span>domainName <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span>stage
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> apigwManagementApi<span class="token punctuation">.</span><span class="token function">postToConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
    ConnectionId<span class="token operator">:</span> event<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span>connectionId<span class="token punctuation">,</span>
    Data<span class="token operator">:</span> event<span class="token punctuation">.</span>body
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span>routeKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'$connect'</span><span class="token operator">:</span>
      <span class="token comment">// TODO</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'$disconnect'</span><span class="token operator">:</span>
      <span class="token comment">// TODO</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'$default'</span><span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token function">echoReply</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return a 200 status to tell API Gateway the message was processed successfully. </span>
  <span class="token comment">// Otherwise, API Gateway will return a 500 to the client.</span>
  <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">&quot;Ok.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You will most likely want to store all active connection ids to database (i.e. DynamoDB), so you can forward messages between the connected clients, instead of simply echoing it back to the same connection.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/aws/dynamodb-javascript/" class="prev">
        DynamoDB with JavaScript
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ec0a4671.js" defer></script><script src="/assets/js/2.fb7a5d33.js" defer></script><script src="/assets/js/12.421c849a.js" defer></script>
  </body>
</html>
